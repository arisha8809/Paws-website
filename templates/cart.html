<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Paws - Cart</title>
  <link href="https://fonts.googleapis.com/css2?family=Bangers&family=Comic+Neue:wght@400;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Permanent+Marker&display=swap" rel="stylesheet">
  <style>
    /* (Keep all the same CSS styles from previous cart.html) */
  </style>
</head>

<body>
  <div class="comic-border"></div>
  
  <div class="header">
    <h1>YOUR CART</h1>
    <p>Review your items before checkout</p>
  </div>

  <div class="cart-container">
    <div class="cart-items" id="cart-items">
      <!-- Cart items will be loaded dynamically -->
    </div>

    <div class="cart-summary" id="cart-summary">
      <!-- Summary will be loaded dynamically -->
    </div>

    <button class="checkout-btn" id="checkout-btn">PROCEED TO CHECKOUT</button>
  </div>

  <!-- Empty cart state (hidden by default) -->
  <div class="cart-container empty-cart" id="empty-cart" style="display: none;">
    <div class="empty-cart-icon">ðŸ›’</div>
    <h2 class="empty-cart-text">YOUR CART IS EMPTY!</h2>
    <a href="{{ url_for('marketplace') }}" class="shop-more-btn">SHOP NOW</a>
  </div>

  <!-- FAB Button from home.html with cart options -->
  <div class="fixed-action-btn spin-close">
    <a class="btn-floating">
      <img src="{{ url_for('static', filename='images/paw.png') }}" alt="Menu" class="paw-icon">
      <span class="action-label">MENU!</span>
    </a>
    <ul>
      <li>
        <a href="{{ url_for('marketplace') }}" class="menu-option">
          <img src="{{ url_for('static', filename='images/marketplace.png') }}" class="icons"> MARKET
        </a>
      </li>
      <li>
        <a href="{{ url_for('profile', username=session.get('username', '')) }}" class="menu-option">
          <img src="{{ url_for('static', filename='images/profile.png') }}" class="icons"> PROFILE
        </a>
      </li>
      <li>
        <a href="{{ url_for('home') }}" class="menu-option">
          <img src="{{ url_for('static', filename='images/home.png') }}" class="icons"> HOME
        </a>
      </li>
    </ul>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // FAB Button functionality
      const fab = document.querySelector('.fixed-action-btn');
      const fabButton = fab.querySelector('.btn-floating');

      fabButton.addEventListener('click', function () {
        fab.classList.toggle('active');
        
        if (fab.classList.contains('active')) {
          fabButton.style.transition = 'all 0.3s ease';
          fabButton.style.transform = 'scale(1.1)';
          
          setTimeout(() => {
            fabButton.style.transform = 'rotate(15deg)';
          }, 100);
        } else {
          fabButton.style.transform = 'scale(1)';
        }
      });

      // Load cart data
      fetchCart();

      // Checkout button
      document.getElementById('checkout-btn').addEventListener('click', function() {
        alert('Checkout functionality would be implemented here!');
      });

      // Function to fetch cart data
      function fetchCart() {
        fetch('/api/cart')
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              if (data.cart_items && data.cart_items.length > 0) {
                renderCart(data.cart_items, data.total);
                document.getElementById('empty-cart').style.display = 'none';
                document.querySelector('.cart-container:not(.empty-cart)').style.display = 'block';
              } else {
                document.getElementById('empty-cart').style.display = 'block';
                document.querySelector('.cart-container:not(.empty-cart)').style.display = 'none';
              }
            } else {
              console.error('Error fetching cart:', data.message);
            }
          })
          .catch(error => console.error('Error:', error));
      }

      // Function to render cart items
      function renderCart(items, total) {
        const cartItemsContainer = document.getElementById('cart-items');
        const cartSummaryContainer = document.getElementById('cart-summary');
        
        // Clear previous items
        cartItemsContainer.innerHTML = '';
        
        // Add cart items
        items.forEach(item => {
          const cartItem = document.createElement('div');
          cartItem.className = 'cart-item';
          cartItem.innerHTML = `
            <img src="{{ url_for('static', filename='uploads/${item.product.image || 'default-product.jpg'}') }}" alt="${item.product.name}" class="item-image">
            <div class="item-details">
              <h3 class="item-name">${item.product.name}</h3>
              <p class="item-price">$${item.product.price.toFixed(2)}</p>
              <div class="item-quantity">
                <span class="quantity-btn minus" data-product-id="${item.product._id}">-</span>
                <span class="quantity-value">${item.quantity}</span>
                <span class="quantity-btn plus" data-product-id="${item.product._id}">+</span>
              </div>
              <button class="remove-item" data-product-id="${item.product._id}">Remove</button>
            </div>
          `;
          cartItemsContainer.appendChild(cartItem);
        });

        // Add cart summary
        cartSummaryContainer.innerHTML = `
          <div class="summary-row">
            <span>Subtotal:</span>
            <span>$${total.subtotal.toFixed(2)}</span>
          </div>
          <div class="summary-row">
            <span>Shipping:</span>
            <span>$${total.shipping.toFixed(2)}</span>
          </div>
          <div class="summary-row summary-total">
            <span>Total:</span>
            <span>$${total.total.toFixed(2)}</span>
          </div>
        `;

        // Add event listeners to quantity buttons
        document.querySelectorAll('.quantity-btn.plus').forEach(btn => {
          btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            updateCartItem(productId, 1);
          });
        });

        document.querySelectorAll('.quantity-btn.minus').forEach(btn => {
          btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            updateCartItem(productId, -1);
          });
        });

        document.querySelectorAll('.remove-item').forEach(btn => {
          btn.addEventListener('click', function() {
            const productId = this.getAttribute('data-product-id');
            removeCartItem(productId);
          });
        });
      }

      // Function to update cart item quantity
      function updateCartItem(productId, change) {
        fetch('/api/cart/update', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            product_id: productId,
            change: change
          })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            fetchCart();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to update cart');
        });
      }

      // Function to remove cart item
      function removeCartItem(productId) {
        fetch('/api/cart/remove', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ product_id: productId })
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            fetchCart();
          } else {
            alert('Error: ' + data.message);
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('Failed to remove item');
        });
      }
    });
  </script>
</body>
</html>